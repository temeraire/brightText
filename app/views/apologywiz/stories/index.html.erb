<style type="text/css" media="screen">
  textarea.dataport{
    width:764px;
    height:392px;
    resize:none;
  }

  DIV.harnesscontainer{
    width:834px;
    height:34px;
    margin:5px;
    padding:5px;
    float:left;
    border: 1px dotted black
  }

  DIV.viewportcontainer{
    width:480px;
    height:140px;
    margin:5px;
    padding:5px;
    float:left;
  }

  DIV.btEditor{
    height:150px;
    padding:10px;
  }

</style>
<ul id="story_tabs" class="nav nav-tabs nav-justified">
  <li class="active"><a id="astep_1" href="#step_1"><h4>Step 1</h4></a></li>
  <li><a id="astep_2" href="#step_2"><h4>Step 2</h4></a></li>
</ul>
<!-- Tab panes -->
<div class="tab-content">
  <div class="tab-pane active" id="step_1">
        <div class="jumbotron">
          <div class="container">
            <div class="col-md-6">
              <%= form_for([:apologywiz, @story], :html => { :role => "form", :class=>"form"}, :validate => true) do |f| %>
              <div class="form-group">
                <label class="control-label">Title</label>
                <%= f.text_field :category, class: 'form-control', placeholder: "example: John's Apologies" %>
              </div>
              <div class="form-group">
                <label class="control-label">Subtitle</label>
                <%= f.text_field :name, class: 'form-control', placeholder: "example: Sorry I've been a creep" %>
              </div>
              <% end %>
            </div>
            <div class="col-md-6">
              <h3>Apologies List</h3>
              <div class="col-md-12" style="overflow: scroll; height: 200px">
                <table id="main-table" class="table table-bordered table-striped tablesorter tablesorter-bootstrap" >
                  <thead>
                    <tr>
                      <th data-sort="string">Name</th>
                    </tr>
                  </thead>
                  <tbody>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
  </div>
  <div class="tab-pane" id="step_2">

      <div class="jumbotron">
        <div class="container">
          <%= form_for([:apologywiz,@story], :validate => true, :html => { :method => :put, class: 'edit_story'}, :remote => true) do |f| %>
          <div class="row">
          <div class="col-md-6">
          <!--   END WAND END WAND END WAND  -->
          <%= f.hidden_field :id, id: 'story_id' %>
          <h3 id="category_name"><%= @story.category %></h3>
          <h4 id="name"><%= @story.name %></h4>
          <label for="description" class="control-label"><h4>Please enter some text</h4></label>
          <div class="row">
            <!--   WAND WAND WAND WAND WAND  -->
            <div id="main_container" class="col-md-12" style="height:250px">
              <div class="panel panel-primary">
                <div class="panel-heading">
                  <h3 class="panel-title">Editor</h3>
                </div>
                <div class="panel-body">
                  <div id="bt_one" class="form-control btEditor">BT Wand</div>
                </div>
              </div>
            </div>
          </div>
          <%= f.hidden_field :description, class: 'txtarea', id: 'fieldSummary' %>
          <%= f.hidden_field :descriptor,  :id => "fieldDescriptor" %>

        </div>
          <div class="col-md-6">
            <br/>
            <div class="bs-callout bs-callout-info">
              <p>Highlight some text and right-click</p>
              <p>Select 'Create Changepoint'</p>
              <p>Enter some alternative text</p>
              <p>Hit 'enter'</p>
              <p>Click away from the Changepoint menu to make it disappear.</p>
              <p>Click on the Changepoint you've created to see your changes. Be sure to Save!</p>
            </div>
          </div>
          </div>
          <div class="row">
            <div class="col-md-2">
              <%= f.submit :id => "save_story_btn", :value => "Save ", :class => "btn btn-primary" %>
            </div>
            <div class="col-md-6 col-md-offset-4">
              <span class="clk"><h4>Advanced Features</h4></span>
              <p><a href="#"><h4>View a video on more advanced features</h4></a></p>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12">
              <h4>Click Save at any time. Then restart the app on your mobile device to see what you created!</h4>
            </div>
          </div>
          <% end %>
        </div>
      </div>

  </div>
</div>


<div id="dialog" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <p id="dialog-message"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Okay</button>
      </div>
    </div>
  </div>
</div>
<script>

  var stories;
  var formSubmitted = false;


  /*
  $('#story_tabs a').click(function(e){
    //e.preventDefault();
    $(this).tab('show');
  });
  */


  $(document).ready(function() {
    $(function(){
      $("#main-table").tablesorter();
    });
/*
    $('span.clk').hover(function(){$("div.bs-callout-info").show();},
                        function(){$("div.bs-callout-info").hide();}
    );
*/
    $(function() {
      $("#main-table").on('click','a.clickme', function(event){
          event.preventDefault();
          var index = $(this).attr("id");
          var story = stories[index];
          $("#story_id").val(story["id"]);
          $("#category_name").html("");
          $("#name").html(story["name"]);
          _bt1.renderData(JSON.parse(story["descriptor"]));
          $('form.edit_story').get(0).setAttribute('action', '/apologywiz/stories/'+ story["id"]);
          $("#astep_2").tab('show');
      });
    });
  });

  $(document).ready(function() {

    _bt1 = new BrightTextEditor("bt_one", true);
    var rawData = $("#fieldDescriptor");
    var textData = $("#fieldSummary");

    _bt1.onChange(function() {
      rawData[0].value = $.toJSON(_bt1.toData());
      textData[0].value = _bt1.toString();
    });
    showStories();
  });

    function showStories(){
         $.ajax({
           type: "get",
           url: "/apologywiz/stories",
           dataType: "json",
           data: "",
           success: function(data) {
             if(data["success"] === "true") {
                stories = data["stories"];
                console.log(stories);
                var rows = "";
                $.each(stories, function (i, apology) {
                  console.log(apology);
                  rows += "<tr>" +
                            "<td><a id='" + i +"' class='clickme' href='#'>" + apology["name"] + "</a></td>" +
                          "</tr>";
                });
                $("#main-table tbody").html("");
                $("#main-table tbody").append(rows);
             }
           }
         });
    };

    $("#astep_1").click(function() {
        formSubmitted = false;
        showStories();
        $(this).tab('show');

    });

    $("#astep_2").click(function() {
      if(formSubmitted===false){
        var title = $("#story_category").val();
        if(title===''){
          $('#dialog-message').replaceWith('<p id=\"dialog-message\">Title can\'t be blank</p>');
          $('#dialog').modal({
            keyboard: true
          });
        }else{
          var subtitle = $("#story_name").val();
          if(subtitle===''){
            $('#dialog-message').replaceWith('<p id=\"dialog-message\">Subtitle can\'t be blank</p>');
            $('#dialog').modal({
              keyboard: true
            });
          }else{
            $.ajax({
              type: "post",
              url: "/apologywiz/stories",
              dataType: "json",
              data: $("#new_story").serialize(),
              success: function(data) {
                formSubmitted = true;
                if(data["id"] !== "") {
                  $("#story_id").val(data["id"]);
                  $("#category_name").text($("#story_category").val());
                  $("#name").text($("#story_name").val());
                  $('form.edit_story').get(0).setAttribute('action', '/apologywiz/stories/'+data["id"]);
                  $('#dialog-message').replaceWith('<p id=\"dialog-message\">Apology was saved successfully</p>');
                  $('#dialog').modal({
                    keyboard: true
                  });
                }
                else if(data["name"]){
                  message = data["name"];
                  $("#story_name").parent().addClass('field_with_errors');
                  $("#story_name + .message").remove();
                  $("#story_name").after('<label class="message" style="margin-top: 50px; display: block; margin-left: 30px;">' + message + '</label>'); $("a[href='.step1']").click();
                }
              }
            });

            $(this).tab('show');

          }
        }
      }
    });





</script>